pipeline {
  agent {
    kubernetes {
      cloud 'terralogic-eks-agent'
      namespace 'cloudbees-builds'
      inheritFrom 'jenkins-kaniko-agent'
      defaultContainer 'jnlp'
    }
  }

  stages {

    /* ================= MAVEN BUILD ================= */
    stage('Maven Build') {
      steps {
        sh """
          mvn clean install \
            -Dmaven.repo.local \
            -DskipTests
        """
      }
    }

    /* ================= SONARQUBE SCAN ================= */
    stage('SonarQube Scan') {
      steps {
        withSonarQubeEnv('sonar-server') {
          sh """
            mvn \
              -Dmaven.repo.local=${MAVEN_REPO} \
              org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
              -Dsonar.projectKey=${sonarProjectKey} \
              -Dsonar.projectName=${sonarProjectKey}
          """
        }
      }
    }

    /* ================= KANIKO BUILD & PUSH ================= */
    stage('Kaniko Build & Push') {
      steps {
        container('kaniko') {
          sh '''
            /kaniko/executor \
              --context /workspace \
              --dockerfile Dockerfile \
              --destination ${IMAGE_NAME}:${IMAGE_TAG} \
              --destination ${IMAGE_NAME}:latest
          '''
        }
      }
    }
  }
}
